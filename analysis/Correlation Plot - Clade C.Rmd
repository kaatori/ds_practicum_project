---
title: "Correlation Plots & Ridge/Lasso Modeling Rounds Plots"
author: "Cassandra Sperow"
date: "2023-11-12"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressMessages(library(tidyverse))
```


- Note: The first several correlation plots relate to exploratory data analysis while other sections towards the end relate to post-modeling analysis with the predictors from 2 rounds of Ridge & Lasso modeling (See 2 Rmd files with Ridge and Lasso in title). The Ridge & Lasso Modeling 2.Rmd is the final results of modeling Clade C vs. non-Clade C. 

# Clade C

```{r}
read_csv("../output/lr_data.csv") %>% 
  mutate(Clade = as.factor(Clade)) -> lr_data

head(lr_data)
```

# Correlation Matrix - Clade C - All
```{r}
cor_matrix_lr_data <- cor(lr_data[,-c(1,2)]) # 3226

```


## Correlation Matrix - Top 20
```{r}



cor_matrix_lr_data[1:20,1:20]
```

```{r}
png(filename = "../plots/top20_corr_clade_c.png",
    width = 1200, height = 800)

library(corrplot)
top20_corr_clade_c <- corrplot(cor_matrix_lr_data[1:20, 1:20], 
                               method = "circle")

```



## Correlation Matrix - Top 50
- Anything over 50 gets small and hard to read
```{r}
png(filename = "../plots/top50_corr_clade_c.png",
    width = 1200, height = 800)

library(corrplot)
top50_corr_clade_c <- corrplot(cor_matrix_lr_data[1:50, 1:50], 
                               method = "circle")

```


# From Lasso Regression with Clade as Binary Outcome, ASV00013 was kept in the model

```{r}
# read in taxonomy table to see which bacterium this is
read_delim("../data/Files/16S_tax.txt") -> bac_tax


bac_tax %>% 
  filter(ASV == "ASV0013") %>% 
  pivot_longer(cols = everything())
```


```{r}
#plot(log(lr_data$ASV0013), lr_data$Clade)

ggplot(lr_data, aes( y = log(ASV0013), color = as.factor(Clade), fill = as.factor(Clade))) +
  geom_histogram() +
  coord_flip() +
  facet_wrap(~Clade) +
  xlab("Log of ASV0013 Counts") +
  ylab("")
```

# Correlation Plot - Both Species - All Data
```{r}
read_csv("../output/rev_coral_join.csv") -> rev_coral_join
```


```{r}
# correlation matrix
corr_matrix_all <- cor(rev_coral_join[,-c(1:8)])

corr_matrix_all[1:20,1:20]

# save the png
png(filename = "../plots/corr_plot_top_20.png",
    width = 1200, height = 900)

# correlation plot
library(corrplot)
corr_plot_top_20 <- corrplot(corr_matrix_all[1:20, 1:20], 
                               method = "circle", 
                             )
```


```{r}
# save the png
png(filename = "../plots/corr_plot_top_100.png",
    width = 1200, height = 900)

# correlation plot
library(corrplot)
corr_plot_top_100 <- corrplot(corr_matrix_all[1:100, 1:100], 
                               method = "circle", 
                              )
```


```{r}
# save the png
png(filename = "../plots/corr_plot_top_50.png",
    width = 1200, height = 900)

# correlation plot
library(corrplot)
corr_plot_top_50 <- corrplot(corr_matrix_all[1:50, 1:50], 
                               method = "circle", 
                              )
```

# Ridge modeling coefficients for 'best' model
```{r}
read_csv("../output/ridge_500_coef_df.csv") -> ridge_results
```

```{r}
ridge_results
```
## Where are these ASVs in relation to one another?
```{r}
cor_matrix_lr_data %>% # data used in clade C modeling
  as.data.frame() %>% 
  mutate(ASV = rownames(.), .before = ASV1236) %>% 
 # filter(ASV %in% c(ridge_results$row_names)) %>% 
  filter(ASV %in% c("ASV6296"	,	"ASV4003"	,"ASV8219"	,	"ASV4449"	) )
  
```
- They are uncorrelated, and ridge would have chosen these because of this.

# Lasso modeling selection
```{r}
read_csv("../output/lasso_500_coef_df.csv") -> lasso_results

lasso_results

cor_matrix_lr_data %>% # data used in clade C modeling
  as.data.frame() %>% 
  mutate(ASV = rownames(.), .before = ASV1236) %>% 
  filter(ASV %in% c("ASV0675"	,	"ASV0013"	,	"ASV0958"	,	"ASV0485"))
```
# Were these clustered consistently in the k-means runs?
```{r}
read_csv("../output/species_P_cluster_assignments.csv") -> clusters_P
read_csv("../output/species_S_cluster_assignments.csv") -> clusters_S

```

```{r}
dim(clusters_P)
dim(clusters_S)
dim(ridge_results)
```

```{r}
ridge_results %>% 
  left_join(clusters_P, join_by("row_names" == "ASV"))


# what is biggest group?
ridge_results %>% 
  left_join(clusters_P, join_by("row_names" == "ASV")) %>% # cluster 3 under seed23_run2
  group_by(seed23_run2) %>% 
  summarise(n = n()) %>% # cluster 3 just happens to be largest group
  arrange(-n)
```

- The ridge results above joined with the clustering results for species P indicate that the first several ASVs with the highest absolute value coefficient in ridge modeling were clustered together consistently in predominantly 3 out of 3 random runs. 

- What does the same thing look like for species S?
```{r}
ridge_results %>% 
  left_join(clusters_S, join_by("row_names" == "ASV"))


ridge_results %>% 
  left_join(clusters_S, join_by("row_names" == "ASV")) %>% # cluster 10 under seed23_run2
  group_by(seed23_run2) %>% 
  summarise(n = n()) %>% # cluster 10 just happens to be largest group
  arrange(-n)
```

- Yes, the ASVs that the ridge model has as its highest absolute value are clustered pretty consistently across 3 out of 3 random runs of K-means. See Coseq_S and Coseq_P files in analysis folder for the k-means runs per species. 

# Revised Modeling Results with Lasso 200 'Best' with Other Variables
- THe above was from the first round of modeling efforts that never got better than around a 30 % error rate. 
- Below is the same uisng the 2nd round of ridge, lasso and tree models where the 'best' model found on ehse data is the lasso with 200 ASV preidctors using also other non-ASV predicors.
- See Ridge and Lasso Modeling 2 in Rmd files in analysis folder

```{r}
readRDS("../output/lasso_coefs.rds") -> lasso_coefs




lasso_coefs[3] %>%  #%>% # 'best' 200 and least complex
  as.data.frame() %>% 
  # exclude other variables except bacteria
  filter(str_detect(predictor, "ASV")) %>% 
  # order by largest magnitude
  arrange(-abs(s1)) %>% 
  select(predictor) %>% 
  as_vector() -> lasso_200_best_asvs
  
```

```{r}
dim(cor_matrix_lr_data) # all Clade C 3226
cor_matrix_lr_data %>% # data used in clade C modeling
  as.data.frame() %>% 
  mutate(ASV = rownames(.), .before = ASV1236) %>% 
 # match the asvc above
  filter(ASV %in% c( lasso_200_best_asvs))
```


### Join Predictors with Cluster Assignments & Review Consistency of Cluster Assignments

```{r}
lasso_coefs[3] %>% 
  as.data.frame() %>% 
  filter(str_detect(predictor, "ASV")) %>% 
  left_join(clusters_P, join_by("predictor" == "ASV")) %>% 
  head




lasso_coefs[3]  %>% 
  as.data.frame() %>% 
  filter(str_detect(predictor, "ASV")) %>% 
  left_join(clusters_S, join_by("predictor" == "ASV")) %>% 
  head
```



### Join Predictors with Cluster Assignments for Largest Cluster
```{r}
lasso_coefs[3] %>% 
  as.data.frame() %>% 
  filter(str_detect(predictor, "ASV")) %>% 
  left_join(clusters_P, join_by("predictor" == "ASV")) %>% 
  group_by(seed23_run2) %>% 
  summarise(n = n()) %>% # mostly cluster 3
  arrange(-n)




lasso_coefs[3]  %>% 
  as.data.frame() %>% 
  filter(str_detect(predictor, "ASV")) %>% 
  left_join(clusters_S, join_by("predictor" == "ASV")) %>% 
  group_by(seed23_run2) %>% 
  summarise(n = n()) %>% # mostly cluster 10
  arrange(-n)
```


# Read in Bacteria Taxonomy
```{r}
read_delim("../data/Files/16S_tax.txt") -> bac_tax
```

### Join Predictors with Cluster Assignments & Taxonomy to Review 
- Cluster runs with K-means were completed by species
- See also 'coseq' files in analysis folder
```{r}
# species P
lasso_coefs[3] %>% 
  as.data.frame() %>% 
  filter(str_detect(predictor, "ASV")) %>% 
  left_join(clusters_P, join_by("predictor" == "ASV")) %>% 
  left_join(bac_tax, join_by("predictor" == "ASV")) %>% 
  group_by(Family, Genus) %>%  # 16 groups
  ungroup() %>% 
  mutate(species = "P") -> predictors_p_df


# species S
lasso_coefs[3]  %>% 
  as.data.frame() %>% 
  filter(str_detect(predictor, "ASV")) %>% 
  left_join(clusters_S, join_by("predictor" == "ASV")) %>% 
  left_join(bac_tax, join_by("predictor" == "ASV")) %>% 
  group_by(Family, Genus) %>%  # 16 groups
  ungroup() %>% 
  mutate(species = "S") -> predictors_s_df


# combine
bind_rows(
predictors_p_df, 
predictors_s_df) -> predictors_clade_c

```


# Plots
```{r}

predictors_clade_c %>% 
  ggplot(aes(x = seed23_run2, fill = Phylum)) +
  geom_histogram(stat = 'count') +
  viridis::scale_fill_viridis(discrete = T) +
  theme_bw() +
  xlab("Cluster Assignment in Seed 23 K-Means") + 
  ggtitle("Lasso 200 Predictors with Cluster Assignnment & Taxonomy") +
  facet_wrap(~paste("Species ", species)) -> plot_phylum

predictors_clade_c %>% 
  ggplot(aes(x = seed23_run2, fill = Class)) +
  geom_histogram(stat = 'count') +
  viridis::scale_fill_viridis(discrete = T) +
  theme_bw() +
  xlab("Cluster Assignment in Seed 23 K-Means") + 
  ggtitle("Lasso 200 Predictors with Cluster Assignnment & Taxonomy") +
  facet_wrap(~paste("Species ", species)) -> plot_class

predictors_clade_c %>% 
  ggplot(aes(x = seed23_run2, fill = Order)) +
  geom_histogram(stat = 'count') +
  viridis::scale_fill_viridis(discrete = T) +
  theme_bw() +
  xlab("Cluster Assignment in Seed 23 K-Means") + 
  ggtitle("Lasso 200 Predictors with Cluster Assignnment & Taxonomy") +
  facet_wrap(~paste("Species ", species)) -> plot_order

predictors_clade_c %>% 
  ggplot(aes(x = seed23_run2, fill = Family)) +
  geom_histogram(stat = 'count') +
  viridis::scale_fill_viridis(discrete = T) +
  theme_bw() +
  xlab("Cluster Assignment in Seed 23 K-Means") + 
  ggtitle("Lasso 200 Predictors with Cluster Assignnment & Taxonomy") +
  facet_wrap(~paste("Species ", species)) -> plot_family

predictors_clade_c %>% 
  ggplot(aes(x = seed23_run2, fill = Genus)) +
  geom_histogram(stat = 'count') +
  viridis::scale_fill_viridis(discrete = T) +
  theme_bw() +
  xlab("Cluster Assignment in Seed 23 K-Means") + 
  ggtitle("Lasso 200 Predictors with Cluster Assignnment & Taxonomy") +
  facet_wrap(~paste("Species ", species)) -> plot_genus

# do not use - most do not have species
# predictors_clade_c %>% 
#   ggplot(aes(x = seed23_run2, fill = Species)) +
#   geom_histogram(stat = 'count') +
#   viridis::scale_fill_viridis(discrete = T) +
#   theme_bw() +
#   xlab("Cluster Assignment in Seed 23 K-Means") + 
#   ggtitle("Lasso 200 Predictors with Cluster Assignnment & Taxonomy") +
#   facet_wrap(~paste("Species ", species))



ggsave(plot = plot_family, "../plots/plot_family.png", 
       width = 12)

gridExtra::grid.arrange(plot_phylum, plot_class,plot_order ,plot_family, plot_genus, ncol = 3) -> five_plots

# Save the combined plots to a PDF file using ggsave
ggsave("../plots/five_plots.pdf", five_plots, width = 17, height = 11, device = "pdf")

```



