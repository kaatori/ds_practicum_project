---
title: "PCA_Revised_Bacteria_Proportions"
author: "Cassandra Sperow"
date: "2023-10-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressMessages(library(tidyverse))
```

## 

# Principal Components Analysis for Revised Bacteria Proportions 

- *Goal*: Find the principal components of the ASV matrix of counts. The number of principal components that explains most of the underlying data may be used as a number "k" clusters for K-Means later. 

- *Method*: Principal Components Analysis (PCA) which is an unsupervised machine learning technique to reduce the dimensionality of the data set. At the present moment, the ASVs are considered to be in p=5,890-dimensional space. PCA seeks to reduce this number of dimensions while still retaining the maximum amount of information in the ASVs.


- Read in revised data of proportions per bacteria per sample: 
```{r}
read_csv("../output/rev_bacteria_prop_df.csv") -> rev_bacteria_prop_df
```


```{r}
# take out sample_id column and scale proportions data
stats::prcomp(rev_bacteria_prop_df[,-1], scale. = T) -> pca_out_prop
```

- Plot the results
```{r}
plot(pca_out_prop)
```

```{r}
library(factoextra)
fviz_pca_var(pca_out_prop, 
             #col.var = "steelblue", 
             col.var = "contrib", 
             gradient.cols = c("red", "blue", "green"), 
            # repel = T, 
            label = "none",
             title = "All Variables in PCA using Bacterial Proprtions")
```

- Create an save summary of PCA results
```{r}
summary(pca_out_prop) -> summary_pca_prop

# subset the results to view the importance df
summary_pca_prop$importance %>% as_tibble() -> importance_matrix
```

- Create new df of importance matrix with row names
```{r}
bind_cols(
  name = c("StndDev", "IndivProp", "CumProp"), 
  importance_matrix
) -> importance_df
```


- Plot individual proportion with cumulative

```{r}
importance_df %>% 
  t() %>% 
  as.data.frame() %>% 
  janitor::row_to_names(1) %>% 
  ggplot(aes(x = as.numeric(CumProp) , y =  as.numeric(IndivProp))) +
  geom_point() +
  ggtitle("PCA Results: Proportion of Variance", "This is a better screeplot showing all PCs on Proprtions-based `rev_bacteria_prop` scaled") +
  xlab("Cumulative Proportion") +
  ylab("Proportion of Variance per Principal Component") +
  theme_bw()
```

**Interpretation** - There are two bacteria strains that seem to be the most influencial. Many other bacteria contribute to explaining the variability of the original data but this levels off relatively quickly. This is indicated by the Cumulative Proportion increasing at a slower rate as the smaller principal components are added. 

```{r}
fviz_pca_ind(pca_out_prop, 
             select.ind = list(contrib = 100),
             col.ind = "#00AFBB",
             #addEllipses=TRUE, ellipse.level=0.85, 
             #palette = "Dark2",
            # palette = c("#999999", "#E69F00", "#56B4E9"),
             repel = TRUE, 
           # label = "var",
            geom = c("arrow", "text"),
            title = "Top 100 Contributing PCs")
```

- How many PCs contribute at least 80 % ?
```{r}
importance_df %>% 
  # pivoting data drame so that cumulatives are in column
  t() %>%  as.data.frame() %>% 
  # moving up top row as column header
  janitor::row_to_names(1) %>% ######## snapshot here for presentation
  # filtering cumulative proportion column for greater > = 80 %
  filter(CumProp >= 0.8)
```
- Same number of PCs as before when first running PCA on counts-based data. See 'PCA_Revised_Bacteria.Rmd'. 

- Which variables are doing what?
```{r}
pca_out_prop$rotation %>% 
  as.data.frame()
```


```{r}
get_pca_var(pca_out_prop) -> vars_prop
```

- Below is accessing what variables contribute to which dimension: 
```{r}
vars_prop$contrib %>% as.data.frame() %>% 
  select(`Dim.1`) %>% 
  arrange(-`Dim.1`)
```

- Plotting the Top 20 ASVs that contribute the most to dimension 1: 
```{r}
fviz_contrib(pca_out_prop, 
             choice = "var", 
             axes = 1,
             top = 20)
```
- Red dashed line represents the expected average contribution. The expected average contribution of each ASV is very low.

- Notice that the max on the y-axis is 0.6 %, so re-plot more to see how adding more changes the % of contribution. Even plotting 50, 70, on up to 100 ASVs still lever gets above 0.6 %:

```{r}
fviz_contrib(pca_out_prop, 
             choice = "var", 
             axes = 1,
             top = 100)
```

- Plot of Dim 2: 
```{r}
fviz_contrib(pca_out_prop, 
             choice = "var", 
             axes = 2,
             top = 20)
```

- Coordinates of Variables
```{r}
vars_prop$coord %>% as.data.frame()
```

- Plot of coordinates for variables

```{r}
fviz_pca_var(pca_out_prop, 
             col.var = "contrib", 
             alpha.var = .5,
             #repel = TRUE,
             title = "Proportion-based, Scaled Bacteria PCA Results \nTop 100 Contributors",
             select.var = list(contrib = 100))
```
Notes on how to interpret: 

Positively correlated variables are grouped together.
Negatively correlated variables are positioned on opposite sides of the plot origin (opposed quadrants).
The distance between variables and the origin measures the quality of the variables on the factor map. Variables that are away from the origin are well represented on the factor map.

Source: http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/112-pca-principal-component-analysis-essentials/#graph-of-variables 

- Get Eigenvalues/Variances
```{r}
eigen_prop <- get_eigenvalue(pca_out_prop)
```

- Eigenvalues can be used to retain the number of components to keep after PCA
- Same as 239 from importance for at least 80 %
- For 90 %:  345 components at least
```{r}
eigen_prop %>% 
  filter(cumulative.variance.percent >= 80)

eigen_prop %>% 
  filter(cumulative.variance.percent >= 90)
```

- Screeplot of Eigenvalues
```{r}
fviz_eig(pca_out_prop, addlabels = TRUE)
```

- How to get list of Dimension 1 Variables?
```{r}

```


```{r}
```


```{r}
```


### What happens if I don't scale the proportions? 
```{r}
stats::prcomp(rev_bacteria_prop_df[,-1]) -> pca_out_prop_NS
```

- Subset importance part of summary output and create separate df for graphing. 
```{r}
summary(pca_out_prop_NS)$importance %>% as_tibble() -> imp2

bind_cols(
  name = c("StndDev", "IndivProp", "CumProp"), 
  imp2
) -> imp2_matrix
```


- When the proportions data are not scaled, the PCA results are very different
```{r}
imp2_matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  janitor::row_to_names(1) %>% 
  ggplot(aes(x = as.numeric(CumProp) , y =  as.numeric(IndivProp))) +
  geom_point() +
  ggtitle("PCA Results: Non-Scaled Proportion of Variance", "This is a better screeplot showing all PCs on Proprtions-based `rev_bacteria_prop` NON-Scaled") +
  xlab("Cumulative Proportion") +
  ylab("Proportion of Variance per Principal Component") +
  theme_bw()

```

- When the proportions data are not scaled, the number of principal components that seem to explain 80 or more % of the X matrix of bacteria goes way down to 7 vs. 239. 
```{r}
imp2_matrix %>% 
  t() %>% 
  as.data.frame() %>% 
    # moving up top row as column header
  janitor::row_to_names(1) %>% ######## snapshot here for presentation
  # filtering cumulative proportion column for greater > = 80 %
  filter(CumProp >= 0.8)
  
```







```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```

