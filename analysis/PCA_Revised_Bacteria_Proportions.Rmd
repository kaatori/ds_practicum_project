---
title: "PCA_Revised_Bacteria_Proportions"
author: "Cassandra Sperow"
date: "2023-10-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressMessages(library(tidyverse))
```

## 

# Principal Components Analysis for Revised Bacteria Proportions 

- Read in revised data of proportions per bacteria per sample: 
```{r}
read_csv("../output/rev_bacteria_prop_df.csv") -> rev_bacteria_prop_df
```


```{r}
# take out sample_id column and scale proportions data
stats::prcomp(rev_bacteria_prop_df[,-1], scale. = T) -> pca_out
```

- Plot the results
```{r}
plot(pca_out)
```

```{r}
library(factoextra)
fviz_pca_var(pca_out, 
             #col.var = "steelblue", 
             col.var = "contrib", 
             gradient.cols = c("red", "blue", "green"), 
            # repel = T, 
            label = "none",
             title = "All Variables in PCA")
```

- Create an save summary of PCA results
```{r}
summary(pca_out) -> summary_pca

# subset the results to view the importance df
summary_pca$importance %>% as_tibble() -> importance_matrix
```

- Create new df of importance matrix with row names
```{r}
bind_cols(
  name = c("StndDev", "IndivProp", "CumProp"), 
  importance_matrix
) -> importance_df
```


- Plot individual proportion with cumulative

```{r}
importance_df %>% 
  t() %>% 
  as.data.frame() %>% 
  janitor::row_to_names(1) %>% 
  ggplot(aes(x = as.numeric(CumProp) , y =  as.numeric(IndivProp))) +
  geom_point() +
  ggtitle("PCA Results: Proportion of Variance", "This is a better screeplot showing all PCs") +
  xlab("Cumulative Proportion") +
  ylab("Proportion of Variance per Principal Component") +
  theme_bw()
```



```{r}
fviz_pca_ind(pca_out, 
             select.ind = list(contrib = 100),
             col.ind = "#00AFBB",
             #addEllipses=TRUE, ellipse.level=0.85, 
             #palette = "Dark2",
            # palette = c("#999999", "#E69F00", "#56B4E9"),
             repel = TRUE, 
           # label = "var",
            geom = c("arrow", "text"),
            title = "Top 100 Contributing PCs")
```

- How many PCs contribute at least 80 % ?
```{r}
importance_df %>% 
  # pivoting data drame so that cumulatives are in column
  t() %>%  as.data.frame() %>% 
  # moving up top row as column header
  janitor::row_to_names(1) %>% ######## snapshot here for presentation
  # filtering cumulative proportion column for greater > = 80 %
  filter(CumProp >= 0.8)
```
- Same number of PCs as before when first running PCA. See 'PCA_Revised_Bacteria_27K'. 












