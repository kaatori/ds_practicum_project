---
title: "Bacteria ASV Table"
author: "Cassandra Sperow"
date: "2023-09-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressMessages(library(tidyverse))
```


# Bacteria (ASV Table)

```{r}
read_delim("../data/Files/ASV_table") -> bacteria

dim(bacteria) #  659 by 33173

head(bacteria)
```

```{r}
tail(bacteria)
```

# Bacteria Taxonomy Table
```{r}
read_delim("../data/Files/16S_tax.txt") -> bacteria_tax

dim(bacteria_tax)
```



```{r}
names(bacteria_tax)
```

### How many bacterial species? 

- 226 but most ASVs have NA as species. For this analysis, the focus is on the ASV as the bacteria strain, but it's good to see how many are not ID'd to a specific species
```{r}
bacteria_tax %>% 
  group_by(Species) %>% 
  summarise(n = n()) %>% 
  arrange(-n)
```

- NA for species is 32904:
```{r}
33173 - 32904
```
- Only 269 of the 33,173 ASVs have been ID'd with a species, otherwise the genera is the next step up in taxonomy. 

### How many different genera? 1,390 with 16,482 having NA as Genus

```{r}  
bacteria_tax %>% 
  group_by(Genus) %>%
  summarise(n = n()) %>%
  arrange(-n) 
```

- Since there are still NAs for Genus, are there NAs for Family? Yes, there are 5115 NAs for Family
- Other than the NAs, there are 482 bacteria Family names

```{r}
bacteria_tax %>% 
  group_by(Family) %>%
  summarise(n = n()) %>%
  arrange(-n) 
```

## What about Order? Are there any NAs?
- There are 308 Orders without any NA values
```{r}
bacteria_tax %>% 
  group_by(Order) %>% 
  summarise(n = n())
```


```{r}
bacteria %>% 
  rename(sample_id = `...1`) -> bacteria
```

## ASV0001 EDA
```{r}
# column to be explored
bacteria$ASV0001

# overview stats of ASV0001 counts (abundance)
summary(bacteria$ASV0001)

# how many rows are 0?
sum(bacteria$ASV0001==0) /nrow(bacteria) # 199 out of 659 samples = 30.2 % are 0 values

plot(bacteria$ASV0001)
```

- The published work from March 2023 (insert link) has the below vizualization with a focus on the top 20 bacterial strains in order of abundance. The ASV numbers indicate the top 20 such that ASV001 - ASC0020 are the ones pictured in the Admixture analysis. 

```{r}
names(bacteria[1:21])
```

### Admixture Analysis from Buitrago-López and Cárdenas, et al

Citation: 

DOI: 10.1111/mec.16871 

![Figure 2 from the publication at DOI: 10.1111/mec.16871 ](../images/Buitrago_Cardenas_at_al_Admixture.png)

# How many different bacteria are there per sample?
- Taking one random sample ID and pivoting ASV columns to see the counts in their own column
- Created a temporary view for this sample ID of how many unique  ASVs there are. 
- Performed this after the pivot by creating a new column with "T" if the ASV count == 0, otherwise "F" 
- Grouped by T/F to see the count of T=zero / F=non-zero because the non-zero values indicate the unique number of ASVs for this sample
```{r}
# for one random sample id: 
bacteria %>% 
  filter(sample_id=="PDOG-R1-1") %>% 
  pivot_longer(cols = starts_with("ASV"), 
               names_to = "ASV", 
               values_to = "count_ASV") %>% 
  # how many unique ASVs are there for this sample?
  # need a 0 vs non-0 binary count column
  mutate(zero = ifelse(count_ASV==0, "T", "F")) %>% 
  # group by the new binary column to see how many ASVs this sample has that are non-0
  group_by(zero) %>% 
  summarise(n = n())

```
- For the sample PDOG-R1-1, there are 203 different bacteria strains linked to this sample, 32969 bacteria strains that were not found in this sample. (32969 + 203 = 33172)

```{r}
32969 + 203
```

## Extend the above method to the entire table to see which samples may have fewer than 3 bacteria strains in that sample in order to filter out some data for manageability. 
```{r}
bacteria %>% 
  # begin pivot for all samples to switch ASV columns into one long column with its ASV name and its corresponding abundance counts all in one other column
  # this will create a very long data frame but is needed to see the zero vs non-zero counts
  pivot_longer(cols = starts_with("ASV"), 
               names_to = "ASV", 
               values_to = "count_ASV") %>% 
  # creating new column for simple grouping
  mutate(zero = ifelse(count_ASV==0, "T", "F")) %>% 
  # before had only pivoted for one sample but below will group by sample and zero or not
  group_by(sample_id, zero) %>% 
  summarise(n = n()) %>% # yes, 1,318 groups is 659 x 2 for T/F in each
  # order by n to see which samples have the most T=zero counts
  arrange(-n)
```
- Many coral samples have at least 33K count values of 0 which means for example, coral sample id PKAU-R1-38 has 33158 ASVs of 0 count. This means 15 bacteria were found in this sample. 
- vs
- Sample id PWAJ-R1-33 has 174 ASV counts of greater than 0. This means that 33,173 - 174 = 32,999 bacteria were found in this sample. 

- **What should be threshold since the least amount of bacteria strains is 15 and the most is 32,999?**

```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```

