---
title: "Coseq"
author: "Cassandra Sperow"
date: "2023-10-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

### Coseq is an R library that works with count-based data to implement clustering with better perofrmance on compositional data
- Coseq transforms the data for better clustering analysis
- The ASV counts are by nature compositional data
- Compositional data are dependent upon the samples taken
- See publication: https://arxiv.org/pdf/1704.06150.pdf

#### Read in count-based data and transpose according to what the package documentation states: 
- Takes a matrix of data.frame of gene-level or ASV-level counts of dimension n x d 
- where n= genes or ASVs as rows and d=samples as columns: 
```{r}
read_csv("../output/rev_bacteria.csv") -> rev_bacteria

rev_bacteria %>% 
  t() %>% 
  as.data.frame() %>% 
  janitor::row_to_names(1) %>% 
  map(., ~as.numeric(.)) %>% 
  as.data.frame() -> t_rev_bacteria_counts
```

- Inspect transposed data frame
- all numeric
- raw counts
- n = ASVs in rows
- d = samples in columns
- See documentation for why it needs to be in this format: 
https://www.bioconductor.org/packages/devel/bioc/vignettes/coseq/inst/doc/coseq.html
```{r}
head(t_rev_bacteria_counts)
```
## Write transposed raw counts df to file for usage later
```{r}
# but first get names of ASVs into column
names(rev_bacteria[-1]) -> names_column

bind_cols(names_column, 
          t_rev_bacteria_counts) -> t_rev_bacteria_counts

write_csv(t_rev_bacteria_counts, "../output/t_rev_bacteria_counts.csv") # no ASV name column but they are in original order

```

#### Quick Start Guide for ```coseq``` package
- It may necessary for new users to go through the commands on this page to set up Bioconductor and coseq:
https://www.bioconductor.org/install/
- Number of K and max iterations are low to try out method first
Note:
### Optional start here, read in in previously transposed data
```{r}
# includes ASV name column
readr::read_csv( "../output/t_rev_bacteria_counts.csv") -> t_rev_bacteria_counts  

```

```{r}
head(t_rev_bacteria_counts)
```

### LogCLR with K-Means using ```coseq```
```{r}
library(coseq)
# try the default method suggested by documentation
# number of iter and number of clusters is low to try out method
coseq(t_rev_bacteria_counts[, -1], # take out ASV names in 1st column
      K=2:25, # experiment with low number
      transformation="logclr", # recommended from research article
      norm="TMM", 
      meanFilterCutoff=50, 
      model="kmeans",
      nstart=1, 
      iter.max=10) -> coseq_out
```


```{r}
# summary
summary(coseq_out)
```


```{r}
# cluster results are putting the samples into two primary clusters
clusters(coseq_out) 
```

- There are two species of coral in dataset
- Maybe this is why it found 2 clusters 


```{r}
# conditional probabilities of cluster membership
assay(coseq_out) %>% as.data.frame()
```

```{r}
class(coseq_out)

#plot(coseq_out)
glimpse(coseq_out)
```

- Per article below, for K-Means, "...the use of untransformed or logCLR-transformed data with K-means thus appears to be a more coherent choice." pg. 12
link: https://arxiv.org/pdf/1704.06150.pdf

### CLR Transformation
- Dr. C advised to use this transformation from the raw counts to the centered log ratio (CLR)
- increasing the max iter
```{r}
# changed transformation type
coseq(t_rev_bacteria_counts[,-1],
      K=2:25, 
      transformation="clr", # centered log ratio
      norm="TMM", # bio-specific setting for these data
      meanFilterCutoff=50, 
      model="kmeans",
      nstart=1, 
      iter.max=10) -> coseq_out_clr
```
- Quick note: mention that it uses MacQueen K-means, 1967
- Mention for further research that different k-means can give different results and can be researched. 
- split into 2 species
- use about 5 seeds per species to show reporducible but also variability. 
```{r}
summary(coseq_out_clr)
```

- With the CLR transformation, the number of clusters stayed the same at 2. 

```{r}
# cluster results
clusters(coseq_out_clr) 
```

```{r}
# conditional probabilities of cluster membership
assay(coseq_out_clr) %>% as.data.frame()
```


-- Changing max iterations to 50 as an experiemnt
```{r}
coseq(t_rev_bacteria_counts[,-1],
      K=2:25, 
      transformation="clr", # centered log ratio
      norm="TMM", # bio-specific setting for these data
      meanFilterCutoff=50, 
      model="kmeans",
      nstart=1, 
      iter.max=50) -> coseq_out_clr_50

summary(coseq_out_clr_50)
```

- The below default plot() function is not working for k-means
```{r}
class(coseq_out_clr_50)
# plot(coseq_out_clr_50, graphs = "biplots")$boxplots
# plot(coseq_out_clr)
```


```{r}
#coseqGlobalPlots(coseq_out_clr_50, graphs = "probapost_histogram")
```
