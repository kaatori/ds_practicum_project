---
title: "Hierarchical Clustering Bacteria"
author: "Cassandra Sperow"
date: "2023-10-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressMessages(library(tidyverse))
library(factoextra)
```


## Hierarchical Clustering

- Thus far, the Hierarchical Clustering has been more stable than K-Means.

### Read in Revised Proportion-based Bacteria Data
```{r}
read_csv("../output/rev_bacteria_prop_df.csv") -> rev_bacteria_prop_df
```


- From Ressler Notes: 

"Build an upside-down tree starting with 
 leaves and work our way up to build a hierarchy of similar observations within clusters.

We have to make two choices:

A measure for distance, here we are using the L2
 Norm but others are possible
A method for determining the “linkage” between the clusters so we can calculate their “dissimilarity”.
Four common linkages: Complete, Single, Average, and Centroid of which Average and Complete are generally preferred.
There are many others.
The linkage can affect the shape of the clusters in p-dimensional 
 space."
 

Another source considered: https://microbiome.github.io/OMA/clustering.html#hierarchical-clustering

## Method 'ward.D2' method mentioned in one of the literature review
- This was mentioned in Yang and Xu (2020) that goes over several methods in relation to microbiome data.
```{r}
# take out sample id column to only scale numeric ASV proportions
# use dist() for the dissimilarity structure that hclust() takes
stats::hclust(dist(scale(rev_bacteria_prop_df[,-1])), method = "ward.D2") -> hcward
```




```{r}
# removing labels for plotting
plot(hcward, 
     labels = F, 
     main = "Cluster 'ward.D2' method")
```
- Put labels at same hieght - worse looking
```{r}
plot(hcward, 
     hang = -1, 
     #labels = F, 
     main = "Cluster 'ward.D2' method")
```

- Convert hclust output into dendrogram and plot
```{r}
hcward_denro <- as.dendrogram(hcward)

# default plot
plot(hcward_denro, type = "rectangle", ylab = "Height")
```

- Dendrogram Plotting
http://www.sthda.com/english/wiki/beautiful-dendrogram-visualizations-in-r-5-must-known-methods-unsupervised-machine-learning

- Zoom in:
```{r}
plot(hcward_denro, type = "rectangle", ylab = "Height",
     xlim = c(0,20), 
     ylim = c(0, 400))
```

### Package 'ape' for plotting dendrograms
```{r}
library(ape)
# pass original output object not dendro object
plot(as.phylo(hcward),
     type = "unrooted",
     label.offset = 0.1
     )

plot(as.phylo(hcward),
     type = "fan",
     label.offset = 0.1
     )
```
### Need to cut tree for reading plots - still doesn't work
```{r}
colors = c("red", "blue", "green", "black", "turquoise", 
           "pink", "chartreuse", "purple", "darkblue", "gray")
hcward_cut = cutree(hcward, 10)
plot(as.phylo(hcward), 
     #type = "radial", 
     tip.color = colors[hcward_cut],
     label.offset = 0.5, cex = 0.7)
```


```{r}
factoextra::fviz_dend(hcward, 
          main = "Title",
          show_labels = T, 
          cex = 0.5, # size of labels
          rect = TRUE, 
          horiz = TRUE, 
          repel = T,
          #rect_border = "none",
          #type = "phylogenic",
          h=300) # cut dendrogram at height 
```




## Method Centroid
```{r}
hcentroid <- stats::hclust(dist(scale(rev_bacteria_prop_df[,-1])), 
                    method = "centroid")
```

```{r}
# base R plot of dendrogram
plot(hcentroid, 
     main = "Default Plot of hcentroid", 
     hang = -1)

class(hcentroid)
```

```{r}
# factoextra dendogram of hclust output
fviz_dend(hcentroid, 
          rect = TRUE, 
          cex = 0.5)

summary(hcentroid)

#hcentroid$order
```

```{r}

```

### Cut Tree 
```{r}
hcentroid_cut <- cutree(hcentroid, 20)
# number of members in each cluster after cutting
table(hcentroid_cut)
length(hcentroid_cut) # 659
```


```{r}
hcentroid_cut[hcentroid_cut >= 150]
```

```{r}
# base R plot of hierarchical clustering output
# with cut tree
plot(hcentroid_cut)
```

```{r}

```


--------from previous attempts
```{r}
#data.frame(hc2, HCC5)
```

```{r}
# library(dendextend)
# avg_dend_obj <- as.dendrogram(HCC)
# avg_col_dend <- color_branches(avg_dend_obj, h = 3)
# plot(avg_col_dend)
```

```{r}

# scaled_data %>% 
#   as_tibble() %>% 
#   mutate(cluster = HCC) %>% 
#   group_by(cluster)
```


https://rpkgs.datanovia.com/factoextra/



